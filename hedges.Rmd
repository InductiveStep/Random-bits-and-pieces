---
title: "R Notebook"
output: html_notebook
---

```{r}
library(lmeInfo)
library(nlme)
library(lme4)
library(eefAnalytics)
```



```{r paged.print=FALSE}
output1 <- crtFREQ(
  Posttest ~ Intervention + Prettest,
  random = "School",
  intervention = "Intervention",
  data = crtData
)

summary(output1)
```


```{r}
test_mod <- lmer(Posttest ~ Intervention + Prettest + (1|School), data = crtData)
test_mod |> summary()
```

```{r}
test_mod_0 <- lmer(Posttest ~ Intervention + (1|School), data = crtData)
```

```{r}
vars <- VarCorr(test_mod_0) |> as.data.frame()
the_sd <- vars$vcov |> sum() |> sqrt()
the_sd
```

```{r}
vars 
```








```{r}
lme_num <- lme(
  fixed = Posttest ~ Intervention + Prettest,
  random = ~ 1 | School,
  data = crtData,
  method = "REML"
)

lme_den <- lme(
  fixed = Posttest ~ Intervention,
  random = ~ 1 | School,
  data = crtData,
  method = "REML"
)
```


```{r paged.print=FALSE}
summary(lme_num)
```



```{r}
the_g <- g_mlm(
  lme_num,
  p_const = c(0,1,0),
  mod_denom = lme_den,
  r_const = c(1,1),
  infotype = "expected",
  separate_variances = FALSE
)

the_g
the_g$delta_AB
```


```{r}
fixef(test_mod)["Intervention"] / the_sd
```





```{r}
b_var <- vcov(test_mod)["Intervention", "Intervention"]
b_var
```


```{r}
library(merDeriv)
ranef_var <- vcov(test_mod_0,
                  full = TRUE,
                  ranpar = "var",
                  information = "expected")[3, 3]

sum_vars <- vars$vcov |> sum()
sqrt((b_var / sum_vars) +
       ((fixef(test_mod)["Intervention"]^2 * ranef_var) / (4 * (sum_vars)^3)))
```

Not far off.


