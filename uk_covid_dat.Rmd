---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
library(viridis)
library(quantmod)
library(patchwork)
```



```{r}
covid_dat <- read.csv("https://api.coronavirus.data.gov.uk/v2/data?areaType=overview&metric=newAdmissions&metric=newCasesBySpecimenDate&metric=newDailyNsoDeathsByDeathDate&metric=newVirusTests&format=csv")
```



```{r}
vax_dat <- read.csv("https://api.coronavirus.data.gov.uk/v2/data?areaType=overview&metric=cumVaccinationCompleteCoverageByPublishDatePercentage&metric=cumVaccinationFirstDoseUptakeByPublishDatePercentage&format=csv")
```




```{r}
dat <- left_join(covid_dat, vax_dat)
```



```{r}
names(dat)
```

```{r}
dat <- dat %>%
  mutate(
    vax_1st = ifelse(
      is.na(cumVaccinationFirstDoseUptakeByPublishDatePercentage),
      0, 
      cumVaccinationFirstDoseUptakeByPublishDatePercentage),
    vax_2nd = ifelse(
      is.na(cumVaccinationCompleteCoverageByPublishDatePercentage),
      0, 
      cumVaccinationCompleteCoverageByPublishDatePercentage)
  )
```



```{r fig.height=3, fig.width=7, dpi=300}
p0a <- dat %>%
  ggplot(
    aes(newCasesBySpecimenDate, newAdmissions,
        colour = vax_1st)) +
  geom_point(size=2) +
  labs(colour = "% first dose",
       x = "Daily cases",
       y = "Daily hospital admissions") +
  scale_colour_steps()

p0a
```


```{r fig.height=3, fig.width=7, dpi=300}
p0b <- dat %>%
  ggplot(
    aes(newCasesBySpecimenDate, newAdmissions,
        colour = vax_2nd)) +
  geom_point(size=2) +
  labs(colour = "% second dose",
       x = "Daily cases",
       y = "Daily hospital admissions") +
  scale_colour_steps()

p0b
```


```{r}
peaky <- dat %>%
  select(date, newAdmissions, newCasesBySpecimenDate) %>%
  arrange(as.Date(date)) %>%
  na.omit() %>%
  mutate(
    i = 1:n(),
    newAdmissions_smooth = stats::filter(newAdmissions, rep(1,40))
  )

plot(peaky$newAdmissions)
```


```{r}
plot(peaky$newAdmissions_smooth)
```


```{r}
the_peaks <- findValleys(peaky$newAdmissions_smooth, thresh = 20)
the_peaks
```




```{r}
peaky <- peaky %>% 
  mutate(peak_cuts = cut(i, c(0,the_peaks,max(i))))

p1 <- peaky %>%
  ggplot(aes(as.Date(date), newAdmissions, colour = peak_cuts)) +
      geom_point() +
      labs(x = "Date",
           y = "Daily hospital admissions") +
  theme(legend.position = "none") +
  scale_x_date(date_labels = "%b %Y")

p1
```



```{r}
p2 <- peaky %>%
  ggplot(
    aes(newCasesBySpecimenDate, newAdmissions,
        colour = peak_cuts)) +
  geom_point() +
  labs(x = "Daily cases",
       y = "Daily hospital admissions") +
  theme(legend.position = "none")

p2
```



```{r fig.height=5, fig.width=9, dpi=300}
(p1/p0a) | (p2/p0b)
```



# Something silly

```{r}
library(flexmix)
```



```{r}
flex_dat <- peaky %>%
  select(date, newAdmissions, newCasesBySpecimenDate) %>%
  na.omit()
```


```{r fig.height=3, fig.width=7, dpi = 300}
flex_mod <- flexmix(newAdmissions ~ newCasesBySpecimenDate,
              data = flex_dat, k = 4)

flex_dat <- flex_dat %>%
  mutate(cluster = factor(clusters(flex_mod)))

g1 <- flex_dat %>%
  ggplot(aes(x = newCasesBySpecimenDate,
             y = newAdmissions,
             colour = cluster)) +
  geom_point() +
  theme(legend.position = "none")

g2 <- flex_dat %>%
  ggplot(aes(x = as.Date(date),
             y = newAdmissions,
             colour = cluster)) +
  geom_point()

g1 | g2
```



